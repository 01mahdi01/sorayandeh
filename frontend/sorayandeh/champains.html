<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>سرآینده | کمپین‌ها</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style/fonts.css" />
    <link rel="stylesheet" href="style/style.css" />
    <link rel="stylesheet" href="style/champains.css" />
  </head>

  <body class="bg-light">
    <!-- هدر -->
    <header class="header shadow-sm">
      <div class="container-fluid">
        <div class="row">
          <div class="col-4 container-login">
            <button class="login-btn">
              <a href="login.html">
                <i class="bi bi-person"></i>
                ورود | ثبت نام
              </a>
            </button>
          </div>
          <div class="col-4 menu-hamburger">
            <!-- دکمه منوی همبرگری -->
            <button
              class="btn btn-primary hum-btn"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#menuCanvas"
              aria-controls="menuCanvas"
            >
              <i class="bi bi-list"></i>
            </button>
          </div>
          <div class="col-4 d-flex justify-content-center container-logo">
            <a href="home.html" class="logo text-dark text-decoration-none">
              <img
                src="image/Screenshot-2024-09-28-140836.png"
                alt="لوگو"
                class="logo"
              />
            </a>
          </div>
          <div class="col-4 container-btn">
            <a href="soalat.html">
              <button class="questions-btn">سوالات متداول</button>
            </a>
            <a href="hemayat.html">
              <button class="support-btn">حمایت از سرآینده</button>
            </a>

            <div class="dropdown">
              <button
                class="menu-btn dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu custom-dropdown-menu">
                <li>
                  <a class="dropdown-item" href="home.html"
                    ><i class="bi bi-house-door"></i> خانه</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="champains.html"
                    ><i class="bi bi-people"></i> کمپین
                  </a>
                </li>

                <li>
                  <a class="dropdown-item" href="about.html"
                    ><i class="bi bi-info-circle"></i> درباره ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="tamasBaMa.html"
                    ><i class="bi bi-telephone"></i> ارتباط با ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="conditions.html"
                    ><i class="bi bi-file-earmark-text"></i> شرایط و ضوابط</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- منوی همبرگری -->
      <div
        class="offcanvas offcanvas-end offcanvas-half"
        tabindex="-1"
        id="menuCanvas"
        aria-labelledby="menuCanvasLabel"
      >
        <div class="offcanvas-header">
          <i class="bi bi-person-circle" style="font-size: 40px"></i>
          <h6 class="login-btn-hum">
            <a href="login.html">ورود و ثبت نام</a>
          </h6>
        </div>
        <div class="offcanvas-body">
          <div class="menu-links">
            <a href="champains.html"> خانه <i class="bi bi-house-door"></i></a>
            <a href="champains.html"> کمپین <i class="bi bi-people"></i></a>
            <a href="hemayat.html"
              >حمایت از سرآینده<i class="bi bi-suit-heart"></i>
            </a>
            <a href="tamasBaMa.html">
              ارتباط با ما<i class="bi bi-telephone"></i
            ></a>
            <a href="about.html"> درباره ما<i class="bi bi-info-circle"></i></a>
            <a href="soalat.html"
              >سوالات متداول<i class="bi bi-question-circle"></i
            ></a>

            <a href="conditions.html">
              شرایط و ضوابط<i class="bi bi-file-earmark-text"></i
            ></a>
          </div>
        </div>
      </div>
    </header>
    <section class="champains">
      <div class="container py-5">
        <h1 class="text-center mb-4">کمپین‌ها</h1>
        <div class="row">
          <!-- بخش فیلترها در سمت راست -->
          <div class="col-md-3">
            <div class="filter-section">
              <h4>فیلترها</h4>
              <form id="filterForm">
                <div class="mb-3">
                  <label for="category" class="form-label"
                    >دسته‌بندی کمپین‌ها</label
                  >
                  <select class="form-select" id="category"></select>
                </div>
                <button type="submit" class="btn btn-primary">
                  اعمال فیلتر
                </button>
              </form>
            </div>
          </div>

          <!-- بخش کارت‌های کمپین در سمت چپ -->
          <div class="col-md-9">
            <!-- بخش جستجو -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="searchInput"
                    placeholder="جستجوی مدرسه..."
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    id="searchButton"
                  >
                    جستجو
                  </button>
                </div>
              </div>
            </div>

            <!-- لودینگ -->
            <div id="loading" class="text-center my-5" style="display: none">
              <i class="fas fa-spinner fa-spin fa-3x"></i>
              <p class="mt-3">در حال دریافت کمپین‌ها، لطفاً منتظر بمانید...</p>
            </div>

            <!-- کارت‌ها -->
            <div class="row g-4" id="campaigns-container">
              <!-- کارت‌ها اینجا به صورت داینامیک ساخته می‌شوند -->
            </div>

            <!-- بخش صفحه‌بندی -->
            <div class="row mt-4">
              <div class="col-md-12 d-flex justify-content-center">
                <nav aria-label="Page navigation">
                  <ul class="pagination" id="pagination">
                    <!-- دکمه‌های صفحه‌بندی اینجا به صورت داینامیک ساخته می‌شوند -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- فوتر -->
    <footer class="footer py-4 mt-5 shadow-sm">
      <div class="container">
        <div class="row text-md-end">
          <!-- ستون اول: درباره ما -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="about.html" class="">
                  درباره ما <i class="bi bi-info-circle"></i>
                </a>
              </li>
              <li>
                <a href="tamasBaMa.html" class="">
                  ارتباط با ما <i class="bi bi-envelope"></i>
                </a>
              </li>
              <li>
                <a href="conditions.html" class="">
                  شرایط و ضوابط <i class="bi bi-file-earmark-text"></i>
                </a>
              </li>
              <li>
                <a href="soalat.html" class="">
                  سوالات متداول <i class="bi bi-question-circle"></i>
                </a>
              </li>
            </ul>
          </div>

          <!-- ستون دوم: لینک‌های مهم -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="tamasBaMa.html"> با ما در ارتباط باشید</a>
              </li>
              <li>
                <span>09231055206</span>
              </li>
            </ul>
          </div>
          <!-- ستون سوم: اطلاعات تماس -->
          <div class="col-md-4 mb-3">
            <img src="image/logo.png" alt="" />
          </div>
        </div>
        <hr />
        <div class="social-icons">
          <a href="" data-title="واتساپ">
            <img src="icons/whatsapp.svg" alt="" class="icon icon-w" />
          </a>
          <a href="" data-title="اینستاگرام">
            <img src="icons/instagramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="تلگرام">
            <img src="icons/telegramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="آپارات">
            <img src="icons/aparath.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="بله">
            <img src="icons/baleh.svg" alt="" class="icon" />
          </a>
        </div>
      </div>
    </footer>

    <script>
      let currentPage = 1;
      let nextPageUrl = null;
      let previousPageUrl = null;
      const displaySize = 9; // تعداد کمپین‌های نمایشی در هر صفحه
      let remainingCampaigns = []; // کمپین‌های باقی‌مانده از درخواست قبلی

      // رویداد DOMContentLoaded برای بارگذاری اولیه
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get("category_id");

        // دریافت دسته‌بندی‌ها از API
        fetchCategories().then(() => {
          // اگر categoryId وجود داشت، گزینه مربوطه را انتخاب کنید
          if (categoryId) {
            const categorySelect = document.getElementById("category");
            categorySelect.value = categoryId;
          }
        });

        // دریافت کمپین‌ها بر اساس دسته‌بندی یا حالت عادی
        if (categoryId) {
          fetchCampaignsByCategory(categoryId, currentPage);
        } else {
          fetchCampaigns(currentPage);
        }
      });

      // تابع برای نمایش لودینگ
      function showLoading() {
        const loadingElement = document.getElementById("loading");
        loadingElement.style.display = "block";
      }

      // تابع برای مخفی کردن لودینگ
      function hideLoading() {
        const loadingElement = document.getElementById("loading");
        loadingElement.style.display = "none";
      }

      // تابع برای دریافت دسته‌بندی‌ها از API
      function fetchCategories() {
        const accessToken = localStorage.getItem("accessToken");

        return fetch(`${BASE_URL}campaigns/get_categories/`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            populateCategories(data);
          })
          .catch((error) => {
            console.error("Error fetching categories:", error);
          });
      }

      // تابع برای پر کردن منوی دسته‌بندی‌ها
      function populateCategories(categories) {
        const categorySelect = document.getElementById("category");

        // افزودن گزینه پیش‌فرض
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "همه";
        categorySelect.appendChild(defaultOption);

        // افزودن گزینه‌های دریافتی از API
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = category.title;
          categorySelect.appendChild(option);
        });
      }

      // تابع برای دریافت کمپین‌ها بر اساس دسته‌بندی
      function fetchCampaignsByCategory(categoryId, page) {
        showLoading(); // نمایش لودینگ
        const accessToken = localStorage.getItem("accessToken");

        fetch(`${BASE_URL}campaigns/filter_by_category/?page=${page}`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ category_id: categoryId }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Filtered campaigns:", data);
            nextPageUrl = data.next;
            previousPageUrl = data.previous;

            const allCampaigns = remainingCampaigns.concat(data.results);
            const campaignsToDisplay = allCampaigns.slice(0, displaySize);
            remainingCampaigns = allCampaigns.slice(displaySize);

            displayCampaigns(campaignsToDisplay);
            updatePagination(data.count, page);
          })
          .catch((error) => {
            console.error("Error fetching campaigns:", error);
          })
          .finally(() => {
            hideLoading(); // مخفی کردن لودینگ
          });
      }

      // تابع برای دریافت کمپین‌ها بر اساس صفحه
      function fetchCampaigns(page) {
        showLoading(); // نمایش لودینگ
        const accessToken = localStorage.getItem("accessToken");

        fetch(`${BASE_URL}campaigns/campaign_list/?page=${page}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Campaigns data:", data);
            nextPageUrl = data.next;
            previousPageUrl = data.previous;

            const allCampaigns = remainingCampaigns.concat(data.results);
            const campaignsToDisplay = allCampaigns.slice(0, displaySize);
            remainingCampaigns = allCampaigns.slice(displaySize);

            displayCampaigns(campaignsToDisplay);
            updatePagination(data.count, page);
          })
          .catch((error) => {
            console.error("Error fetching campaigns:", error);
          })
          .finally(() => {
            hideLoading(); // مخفی کردن لودینگ
          });
      }

      // تابع برای جستجوی کمپین‌ها بر اساس نام مدرسه
      function fetchCampaignsBySchool(schoolName, page) {
        showLoading(); // نمایش لودینگ
        const accessToken = localStorage.getItem("accessToken");

        fetch(`${BASE_URL}campaigns/search_by_school/?page=${page}`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ name: schoolName }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Searched campaigns:", data);
            const { pagination, results } = data;

            nextPageUrl = pagination.has_next ? page + 1 : null;
            previousPageUrl = pagination.has_previous ? page - 1 : null;

            const allCampaigns = remainingCampaigns.concat(results);
            const campaignsToDisplay = allCampaigns.slice(0, displaySize);
            remainingCampaigns = allCampaigns.slice(displaySize);

            displayCampaigns(campaignsToDisplay);
            updatePagination(
              pagination.total_count,
              page,
              pagination.total_pages
            );
          })
          .catch((error) => {
            console.error("Error searching campaigns:", error);
          })
          .finally(() => {
            hideLoading(); // مخفی کردن لودینگ
          });
      }

      // تابع برای نمایش کمپین‌ها
      function displayCampaigns(campaigns) {
        const campaignsContainer = document.getElementById(
          "campaigns-container"
        );
        campaignsContainer.innerHTML = "";

        if (campaigns && campaigns.length > 0) {
          campaigns.forEach((campaign) => {
            const cardHTML = createCampaignCard(campaign);
            campaignsContainer.insertAdjacentHTML("beforeend", cardHTML);
          });
        } else {
          campaignsContainer.innerHTML = "<p>هیچ کمپینی یافت نشد.</p>";
        }
      }

      // تابع برای ایجاد کارت کمپین
      function createCampaignCard(campaign) {
        const firstImage =
          campaign.gallery && campaign.gallery.length > 0
            ? `${BASE_URL}media/${campaign.gallery[0]}`
            : "image/placeholder.jpg";

        const steelNeededMoney = campaign.steel_needed_money || 0;
        const estimatedMoney = campaign.estimated_money || 0;
        const collectedMoney = estimatedMoney - steelNeededMoney;
        const progressPercentage =
          estimatedMoney === 0
            ? 0
            : Math.round((collectedMoney / estimatedMoney) * 100);

        const schoolName =
          campaign.applicant_info?.schoolName || "نام مدرسه نامشخص";
        const description = campaign.description || "بدون توضیحات";

        return `
    <div class="col-md-4">
      <div class="card campaign-card">
        <img src="${firstImage}" class="campaign-image" alt="${
          campaign.title || "بدون عنوان"
        }">
        <div class="card-body">
          <h5 class="card-title">${campaign.title || "بدون عنوان"}</h5>
          <p class="card-text text-muted">دسته‌بندی: ${
            campaign.category || "بدون توضیحات"
          }</p>
          <p class="card-text"><strong>توضیحات:</strong> ${description}</p>
          <p class="school-name">مدرسه: ${schoolName}</p>
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: ${progressPercentage}%" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100">
              <span>${progressPercentage}%</span>
            </div>
          </div>
          <div class="amount-info mt-3">
            <p><strong>${collectedMoney.toLocaleString()} تومان از ${estimatedMoney.toLocaleString()} تومان</strong></p>
          </div>
          <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-donate">کمک کردن</button>
            <a href="detailsChampain.html?id=${
              campaign.id
            }" class="btn btn-outline-primary btn-champain-details">جزئیات بیشتر</a>
          </div>
        </div>
      </div>
    </div>
  `;
      }

      // تابع برای به‌روزرسانی صفحه‌بندی
      function updatePagination(totalItems, currentPage) {
        const paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = "";

        const totalPages = Math.ceil(totalItems / displaySize);

        // دکمه قبلی
        const previousButton = document.createElement("li");
        previousButton.classList.add("page-item");
        if (!previousPageUrl) {
          previousButton.classList.add("disabled");
        }
        previousButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${
          currentPage - 1
        })">قبلی</a>`;
        paginationContainer.appendChild(previousButton);

        // دکمه‌های شماره صفحه
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement("li");
          pageButton.classList.add("page-item");
          if (i === currentPage) {
            pageButton.classList.add("active");
          }
          pageButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
          paginationContainer.appendChild(pageButton);
        }

        // دکمه بعدی
        const nextButton = document.createElement("li");
        nextButton.classList.add("page-item");
        if (!nextPageUrl) {
          nextButton.classList.add("disabled");
        }
        nextButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${
          currentPage + 1
        })">بعدی</a>`;
        paginationContainer.appendChild(nextButton);
      }

      // تابع برای تغییر صفحه
      function changePage(page) {
        currentPage = page;
        const categoryId = document.getElementById("category").value;
        const searchInput = document.getElementById("searchInput").value;

        if (searchInput) {
          fetchCampaignsBySchool(searchInput, currentPage);
        } else if (categoryId) {
          fetchCampaignsByCategory(categoryId, currentPage);
        } else {
          fetchCampaigns(currentPage);
        }
      }

      // اعمال فیلتر دسته‌بندی
      const filterForm = document.getElementById("filterForm");
      filterForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const categoryId = document.getElementById("category").value;
        const searchInput = document.getElementById("searchInput");

        // پاک کردن متن جست‌وجو
        searchInput.value = "";

        currentPage = 1; // ریست کردن صفحه به ۱ هنگام اعمال فیلتر
        remainingCampaigns = []; // پاک کردن کمپین‌های باقی‌مانده

        // اگر دسته‌بندی انتخاب شده باشد، کمپین‌های مربوطه را دریافت کنید
        if (categoryId) {
          fetchCampaignsByCategory(categoryId, currentPage);
        } else {
          // اگر دسته‌بندی "همه" انتخاب شده باشد، همه کمپین‌ها را دریافت کنید
          fetchCampaigns(currentPage);
        }
      });

      // اعمال جستجو بر اساس نام مدرسه
      const searchButton = document.getElementById("searchButton");
      searchButton.addEventListener("click", function () {
        const searchInput = document.getElementById("searchInput").value;
        currentPage = 1; // ریست کردن صفحه به ۱ هنگام جستجو
        remainingCampaigns = []; // پاک کردن کمپین‌های باقی‌مانده

        if (searchInput) {
          fetchCampaignsBySchool(searchInput, currentPage);
        } else {
          // اگر فیلد جستجو خالی باشد، همه کمپین‌ها را دریافت کنید
          fetchCampaigns(currentPage);
        }
      });
    </script>

    <!-- اسکریپت فیلتر قیمت  -->
    <!-- <script>
      document.addEventListener("DOMContentLoaded", function () {
        const minAmountSlider = document.getElementById("minAmount");
        const maxAmountSlider = document.getElementById("maxAmount");
        const minAmountValue = document.getElementById("minAmountValue");
        const maxAmountValue = document.getElementById("maxAmountValue");
        const rangeTrack = document.querySelector(".range-track");

        تابع برای فرمت کردن اعداد به صورت مالی
        function formatCurrency(value) {
          return new Intl.NumberFormat("fa-IR").format(value) + " تومان";
        }

        تابع برای به‌روزرسانی قسمت آبی اسلایدر
        function updateRangeTrack() {
          const minPercent =
            (minAmountSlider.value / minAmountSlider.max) * 100;
          const maxPercent =
            (maxAmountSlider.value / maxAmountSlider.max) * 100;
          rangeTrack.style.left = `${100 - maxPercent}%`;
          rangeTrack.style.right = `${minPercent}%`;
        }

        مقدار اولیه را تنظیم می‌کنیم
        minAmountValue.textContent = formatCurrency(minAmountSlider.value);
        maxAmountValue.textContent = formatCurrency(maxAmountSlider.value);
        updateRangeTrack();

        رویداد تغییر مقدار اسلایدر حداقل
        minAmountSlider.addEventListener("input", function () {
          اطمینان حاصل کنید که حداقل از حداکثر بیشتر نباشد
          if (
            parseInt(minAmountSlider.value) > parseInt(maxAmountSlider.value)
          ) {
            minAmountSlider.value = maxAmountSlider.value;
          }
          minAmountValue.textContent = formatCurrency(minAmountSlider.value);
          updateRangeTrack();
        });

        رویداد تغییر مقدار اسلایدر حداکثر
        maxAmountSlider.addEventListener("input", function () {
          اطمینان حاصل کنید که حداکثر از حداقل کمتر نباشد
          if (
            parseInt(maxAmountSlider.value) < parseInt(minAmountSlider.value)
          ) {
            maxAmountSlider.value = minAmountSlider.value;
          }
          maxAmountValue.textContent = formatCurrency(maxAmountSlider.value);
          updateRangeTrack();
        });
      });
    </script> -->
    <script src="app/baseConfig.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app/logintest.js"></script>
  </body>
</html>
