<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>سرآینده | کمپین‌ها</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style/fonts.css" />
    <link rel="stylesheet" href="style/style.css" />
    <link rel="stylesheet" href="style/champains.css" />
  </head>
  <body class="bg-light">
    <!-- هدر -->
    <header class="header shadow-sm">
      <div class="container-fluid">
        <div class="row">
          <div class="col-4 container-login">
            <button class="login-btn">
              <a href="login.html">
                <i class="bi bi-person"></i>
                ورود | ثبت نام
              </a>
            </button>
          </div>
          <div class="col-4 menu-hamburger">
            <!-- دکمه منوی همبرگری -->
            <button
              class="btn btn-primary hum-btn"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#menuCanvas"
              aria-controls="menuCanvas"
            >
              <i class="bi bi-list"></i>
            </button>
          </div>
          <div class="col-4 d-flex justify-content-center container-logo">
            <a href="home.html" class="logo text-dark text-decoration-none">
              <img
                src="image/Screenshot-2024-09-28-140836.png"
                alt="لوگو"
                class="logo"
              />
            </a>
          </div>
          <div class="col-4 container-btn">
            <a href="soalat.html">
              <button class="questions-btn">سوالات متداول</button>
            </a>
            <a href="hemayat.html">
              <button class="support-btn">حمایت از سرآینده</button>
            </a>

            <div class="dropdown">
              <button
                class="menu-btn dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu custom-dropdown-menu">
                <li>
                  <a class="dropdown-item" href="home.html"
                    ><i class="bi bi-house-door"></i> خانه</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="champains.html"
                    ><i class="bi bi-people"></i> کمپین
                  </a>
                </li>

                <li>
                  <a class="dropdown-item" href="about.html"
                    ><i class="bi bi-info-circle"></i> درباره ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="tamasBaMa.html"
                    ><i class="bi bi-telephone"></i> ارتباط با ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="conditions.html"
                    ><i class="bi bi-file-earmark-text"></i> شرایط و ضوابط</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- منوی همبرگری -->
      <div
        class="offcanvas offcanvas-end offcanvas-half"
        tabindex="-1"
        id="menuCanvas"
        aria-labelledby="menuCanvasLabel"
      >
        <div class="offcanvas-header">
          <i class="bi bi-person-circle" style="font-size: 40px"></i>
          <h6 class="login-btn-hum">
            <a href="login.html">ورود و ثبت نام</a>
          </h6>
        </div>
        <div class="offcanvas-body">
          <div class="menu-links">
            <a href="champains.html"> خانه <i class="bi bi-house-door"></i></a>
            <a href="champains.html"> کمپین <i class="bi bi-people"></i></a>
            <a href="hemayat.html"
              >حمایت از سرآینده<i class="bi bi-suit-heart"></i>
            </a>
            <a href="tamasBaMa.html">
              ارتباط با ما<i class="bi bi-telephone"></i
            ></a>
            <a href="about.html"> درباره ما<i class="bi bi-info-circle"></i></a>
            <a href="soalat.html"
              >سوالات متداول<i class="bi bi-question-circle"></i
            ></a>

            <a href="conditions.html">
              شرایط و ضوابط<i class="bi bi-file-earmark-text"></i
            ></a>
          </div>
        </div>
      </div>
    </header>
    <section class="champains">
      <div class="container py-5">
        <h1 class="text-center mb-4">کمپین‌ها</h1>
        <div class="row">
          <!-- بخش فیلترها در سمت راست -->
          <div class="col-md-3">
            <div class="filter-section">
              <h4>فیلترها</h4>
              <form id="filterForm">
                <!-- بخش جدید: فیلتر شهر -->
                <!-- <div class="mb-3">
                  <label for="city" class="form-label">شهر</label>
                  <select class="form-select" id="city">
                    <option selected>همه</option>
                    <option>تهران</option>
                    <option>مشهد</option>
                    <option>اصفهان</option>
                    <option>شیراز</option>
                    <option>تبریز</option>
                  </select>
                </div> -->
                <div class="mb-3">
                  <label for="category" class="form-label"
                    >دسته‌بندی کمپین‌ها</label
                  >
                  <select class="form-select" id="category"></select>
                </div>
                <!-- <div class="mb-3">
                  <label for="rangeSlider" class="form-label"
                    >محدوده مبلغ</label
                  >
                  <div class="range-slider">
                    <input
                      type="range"
                      class="form-range"
                      id="minAmount"
                      min="0"
                      max="10000000"
                      step="100000"
                      value="0"
                    />
                    <input
                      type="range"
                      class="form-range"
                      id="maxAmount"
                      min="0"
                      max="10000000"
                      step="100000"
                      value="10000000"
                    />
                    <div class="range-track"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <span id="minAmountValue">0 تومان</span>
                    <span id="maxAmountValue">10,000,000 تومان</span>
                  </div>
                </div> -->
                <button type="submit" class="btn btn-primary">
                  اعمال فیلتر
                </button>
              </form>
            </div>
          </div>

          <!-- بخش کارت‌های کمپین در سمت چپ -->
          <div class="col-md-9">
            <!-- بخش جستجو -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="searchInput"
                    placeholder="جستجوی کمپین‌ها..."
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    id="searchButton"
                  >
                    جستجو
                  </button>
                </div>
              </div>
            </div>

            <!-- کارت‌ها -->
            <div class="row g-4" id="campaigns-container">
              <!-- کارت‌ها اینجا به صورت داینامیک ساخته می‌شوند -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- فوتر -->
    <footer class="footer py-4 mt-5 shadow-sm">
      <div class="container">
        <div class="row text-md-end">
          <!-- ستون اول: درباره ما -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="about.html" class="">
                  درباره ما <i class="bi bi-info-circle"></i>
                </a>
              </li>
              <li>
                <a href="tamasBaMa.html" class="">
                  ارتباط با ما <i class="bi bi-envelope"></i>
                </a>
              </li>
              <li>
                <a href="conditions.html" class="">
                  شرایط و ضوابط <i class="bi bi-file-earmark-text"></i>
                </a>
              </li>
              <li>
                <a href="soalat.html" class="">
                  سوالات متداول <i class="bi bi-question-circle"></i>
                </a>
              </li>
            </ul>
          </div>

          <!-- ستون دوم: لینک‌های مهم -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="tamasBaMa.html"> با ما در ارتباط باشید</a>
              </li>
              <li>
                <span>09231055206</span>
              </li>
            </ul>
          </div>
          <!-- ستون سوم: اطلاعات تماس -->
          <div class="col-md-4 mb-3">
            <img src="image/logo.png" alt="" />
          </div>
        </div>
        <hr />
        <div class="social-icons">
          <a href="" data-title="واتساپ">
            <img src="icons/whatsapp.svg" alt="" class="icon icon-w" />
          </a>
          <a href="" data-title="اینستاگرام">
            <img src="icons/instagramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="تلگرام">
            <img src="icons/telegramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="آپارات">
            <img src="icons/aparath.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="بله">
            <img src="icons/baleh.svg" alt="" class="icon" />
          </a>
        </div>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get("category_id");

        // دریافت دسته‌بندی‌ها از بک‌اند
        fetchCategories().then(() => {
          // اگر categoryId وجود داشت، گزینه مربوطه را انتخاب کنید
          if (categoryId) {
            const categorySelect = document.getElementById("category");
            categorySelect.value = categoryId;
          }
        });

        // دریافت کمپین‌ها بر اساس دسته‌بندی
        if (categoryId) {
          fetchCampaignsByCategory(categoryId);
        } else {
          fetchAllCampaigns();
        }
      });

      // تابع برای دریافت دسته‌بندی‌ها از بک‌اند
      function fetchCategories() {
        const accessToken = localStorage.getItem("accessToken");

        return fetch(`${BASE_URL}campaigns/get_categories/`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            populateCategories(data);
          })
          .catch((error) => {
            console.error("Error fetching categories:", error);
          });
      }

      // تابع برای پر کردن منوی دسته‌بندی‌ها
      function populateCategories(categories) {
        const categorySelect = document.getElementById("category");

        // افزودن گزینه پیش‌فرض
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "همه";
        categorySelect.appendChild(defaultOption);

        // افزودن گزینه‌های دریافتی از API
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = category.title;
          categorySelect.appendChild(option);
        });
      }

      // تابع برای دریافت کمپین‌ها بر اساس دسته‌بندی
      function fetchCampaignsByCategory(categoryId) {
        const accessToken = localStorage.getItem("accessToken");

        fetch(`${BASE_URL}campaigns/filter_by_category/`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ category_id: categoryId }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Filtered campaigns:", data); // برای دیباگ
            displayCampaigns(data.results);
          })
          .catch((error) => {
            console.error("Error fetching campaigns:", error);
          });
      }

      // تابع برای دریافت همه کمپین‌ها
      function fetchAllCampaigns() {
        const accessToken = localStorage.getItem("accessToken");

        fetch(`${BASE_URL}campaigns/campaign_list/`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("All campaigns:", data); // برای دیباگ
            displayCampaigns(data.results);
          })
          .catch((error) => {
            console.error("Error fetching campaigns:", error);
          });
      }

      // تابع برای نمایش کمپین‌ها
      function displayCampaigns(campaigns) {
        const campaignsContainer = document.getElementById(
          "campaigns-container"
        );
        campaignsContainer.innerHTML = "";

        if (campaigns && campaigns.length > 0) {
          campaigns.forEach((campaign) => {
            const cardHTML = createCampaignCard(campaign);
            campaignsContainer.insertAdjacentHTML("beforeend", cardHTML);
          });
        } else {
          campaignsContainer.innerHTML = "<p>هیچ کمپینی یافت نشد.</p>";
        }
      }

      // تابع برای ایجاد کارت کمپین
      function createCampaignCard(campaign) {
        const firstImage =
          campaign.gallery && campaign.gallery.length > 0
            ? `${BASE_URL}media/${campaign.gallery[0]}`
            : "image/placeholder.jpg";

        const steelNeededMoney =
          campaign.steel_needed_money === null
            ? 0
            : parseFloat(campaign.steel_needed_money);

        const estimatedMoney = parseFloat(campaign.estimated_money);

        // محاسبه مبلغ جمع‌آوری‌شده
        const collectedMoney = estimatedMoney - steelNeededMoney;

        // محاسبه درصد پیشرفت
        const progressPercentage =
          estimatedMoney === 0
            ? 0
            : Math.round((collectedMoney / estimatedMoney) * 100);

        return `
          <div class="col-md-4">
            <div class="card campaign-card">
              <img src="${firstImage}" class="campaign-image" alt="${
          campaign.title || "بدون عنوان"
        }" />
              <div class="card-body">
                <h5 class="card-title">${campaign.title || "بدون عنوان"}</h5>
                <p class="card-text text-muted">دسته‌بندی: ${
                  campaign.category || "بدون توضیحات"
                }</p>
                <p class="card-text">${
                  campaign.description || "بدون توضیحات"
                }</p>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: ${progressPercentage}%" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100">
                    <span>${progressPercentage}%</span>
                  </div>
                </div>
                <div class="amount-info mt-3">
                  <p><strong>${collectedMoney.toLocaleString()} تومان از ${estimatedMoney.toLocaleString()} تومان</strong></p>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <button class="btn btn-donate">کمک کردن</button>
                  <a href="detailsChampain.html?id=${
                    campaign.id
                  }" class="btn btn-outline-primary btn-champain-details">جزئیات بیشتر</a>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // اعمال فیلتر دسته‌بندی
      const filterForm = document.getElementById("filterForm");
      filterForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const categoryId = document.getElementById("category").value;

        // اگر دسته‌بندی انتخاب شده باشد، کمپین‌های مربوطه را دریافت کنید
        if (categoryId) {
          fetchCampaignsByCategory(categoryId);
        } else {
          // اگر دسته‌بندی "همه" انتخاب شده باشد، همه کمپین‌ها را دریافت کنید
          fetchAllCampaigns();
        }
      });
    </script>

    <!-- اسکریپت فیلتر قیمت  -->
    <!-- <script>
      document.addEventListener("DOMContentLoaded", function () {
        const minAmountSlider = document.getElementById("minAmount");
        const maxAmountSlider = document.getElementById("maxAmount");
        const minAmountValue = document.getElementById("minAmountValue");
        const maxAmountValue = document.getElementById("maxAmountValue");
        const rangeTrack = document.querySelector(".range-track");

        تابع برای فرمت کردن اعداد به صورت مالی
        function formatCurrency(value) {
          return new Intl.NumberFormat("fa-IR").format(value) + " تومان";
        }

        تابع برای به‌روزرسانی قسمت آبی اسلایدر
        function updateRangeTrack() {
          const minPercent =
            (minAmountSlider.value / minAmountSlider.max) * 100;
          const maxPercent =
            (maxAmountSlider.value / maxAmountSlider.max) * 100;
          rangeTrack.style.left = `${100 - maxPercent}%`;
          rangeTrack.style.right = `${minPercent}%`;
        }

        مقدار اولیه را تنظیم می‌کنیم
        minAmountValue.textContent = formatCurrency(minAmountSlider.value);
        maxAmountValue.textContent = formatCurrency(maxAmountSlider.value);
        updateRangeTrack();

        رویداد تغییر مقدار اسلایدر حداقل
        minAmountSlider.addEventListener("input", function () {
          اطمینان حاصل کنید که حداقل از حداکثر بیشتر نباشد
          if (
            parseInt(minAmountSlider.value) > parseInt(maxAmountSlider.value)
          ) {
            minAmountSlider.value = maxAmountSlider.value;
          }
          minAmountValue.textContent = formatCurrency(minAmountSlider.value);
          updateRangeTrack();
        });

        رویداد تغییر مقدار اسلایدر حداکثر
        maxAmountSlider.addEventListener("input", function () {
          اطمینان حاصل کنید که حداکثر از حداقل کمتر نباشد
          if (
            parseInt(maxAmountSlider.value) < parseInt(minAmountSlider.value)
          ) {
            maxAmountSlider.value = minAmountSlider.value;
          }
          maxAmountValue.textContent = formatCurrency(maxAmountSlider.value);
          updateRangeTrack();
        });
      });
    </script> -->
    <script src="app/baseConfig.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app/logintest.js"></script>
  </body>
</html>
