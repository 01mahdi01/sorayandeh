<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>جزئیات کمپین</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style/fonts.css" />
    <link rel="stylesheet" href="style/style.css" />
    <style>
      .campaign-details {
        margin-top: 80px;
      }
      /* استایل‌های عکس در بخش اطلاعات کلی */
      #campaign-image {
        width: 100%; /* عرض عکس */
        height: 300px; /* ارتفاع عکس */
        object-fit: cover; /* حفظ نسبت ابعاد و پر کردن فضای تعیین‌شده */
        border-radius: 8px; /* گوشه‌های گرد */
      }

      .donors-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .donor-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      .donor-item:last-child {
        border-bottom: none;
      }

      .donor-name {
        font-weight: bold;
      }

      .donor-amount {
        color: #28a745; /* رنگ سبز برای مبلغ */
      }

      .campaign-gallery img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin: 5px;
        border-radius: 5px;
      }

      .donation-section {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
      }

      .suggested-amounts {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
      }

      .suggested-amounts .btn {
        flex: 1 1 calc(25% - 10px);
        max-width: calc(25% - 10px);
      }

      .amount-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .amount-input-container input {
        flex: 1;
      }

      .amount-input-container span {
        white-space: nowrap;
      }

      /* استایل‌های نشان‌دهنده دایره‌ای درصد پیشرفت */
      .circle-progress {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 20px auto;
      }

      .circle-progress svg {
        width: 100%;
        height: 100%;
      }

      .circle-progress circle {
        fill: none;
        stroke: #e0e0e0; /* رنگ پس‌زمینه دایره */
        stroke-width: 10;
      }

      .circle-progress .circle-progress-bar {
        fill: none;
        stroke: #28a745; /* رنگ پیشرفت */
        stroke-width: 10;
        stroke-dasharray: 314; /* محیط دایره (2 * π * r) */
        stroke-dashoffset: 314; /* مقدار اولیه (دایره خالی) */
        transition: stroke-dashoffset 0.5s ease;
      }

      .circle-progress .circle-progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        font-weight: bold;
        color: #28a745; /* رنگ متن درصد */
      }
    </style>
  </head>
  <body>
    <!-- هدر -->
    <header class="header shadow-sm">
      <div class="container-fluid">
        <div class="row">
          <div class="col-4 container-login">
            <button class="login-btn">
              <a href="login.html">
                <i class="bi bi-person"></i>
                ورود | ثبت نام
              </a>
            </button>
          </div>
          <div class="col-4 menu-hamburger">
            <!-- دکمه منوی همبرگری -->
            <button
              class="btn btn-primary hum-btn"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#menuCanvas"
              aria-controls="menuCanvas"
            >
              <i class="bi bi-list"></i>
            </button>
          </div>
          <div class="col-4 d-flex justify-content-center container-logo">
            <a href="home.html" class="logo text-dark text-decoration-none">
              <img
                src="image/Screenshot-2024-09-28-140836.png"
                alt="لوگو"
                class="logo"
              />
            </a>
          </div>
          <div class="col-4 container-btn">
            <a href="soalat.html">
              <button class="questions-btn">سوالات متداول</button>
            </a>
            <a href="hemayat.html">
              <button class="support-btn">حمایت از سرآینده</button>
            </a>

            <div class="dropdown">
              <button
                class="menu-btn dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu custom-dropdown-menu">
                <li>
                  <a class="dropdown-item" href="home.html"
                    ><i class="bi bi-house-door"></i> خانه</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="champains.html"
                    ><i class="bi bi-people"></i> کمپین
                  </a>
                </li>

                <li>
                  <a class="dropdown-item" href="about.html"
                    ><i class="bi bi-info-circle"></i> درباره ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="tamasBaMa.html"
                    ><i class="bi bi-telephone"></i> ارتباط با ما</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="conditions.html"
                    ><i class="bi bi-file-earmark-text"></i> شرایط و ضوابط</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- منوی همبرگری -->
      <div
        class="offcanvas offcanvas-end offcanvas-half"
        tabindex="-1"
        id="menuCanvas"
        aria-labelledby="menuCanvasLabel"
      >
        <div class="offcanvas-header">
          <i class="bi bi-person-circle" style="font-size: 40px"></i>
          <h6 class="login-btn-hum">
            <a href="login.html">ورود و ثبت نام</a>
          </h6>
        </div>
        <div class="offcanvas-body">
          <div class="menu-links">
            <a href="champains.html"> خانه <i class="bi bi-house-door"></i></a>
            <a href="champains.html"> کمپین <i class="bi bi-people"></i></a>
            <a href="hemayat.html"
              >حمایت از سرآینده<i class="bi bi-suit-heart"></i>
            </a>
            <a href="tamasBaMa.html">
              ارتباط با ما<i class="bi bi-telephone"></i
            ></a>
            <a href="about.html"> درباره ما<i class="bi bi-info-circle"></i></a>
            <a href="soalat.html"
              >سوالات متداول<i class="bi bi-question-circle"></i
            ></a>

            <a href="conditions.html">
              شرایط و ضوابط<i class="bi bi-file-earmark-text"></i
            ></a>
          </div>
        </div>
      </div>
    </header>
    <section class="campaign-details">
      <div class="container py-5">
        <div class="row">
          <!-- بخش تصویر و اطلاعات کلی -->
          <div class="col-md-8">
            <div class="card mb-4">
              <img
                id="campaign-image"
                src="/image/bg001.jpg"
                class="card-img-top"
                alt="عنوان کمپین"
              />
              <div class="card-body">
                <h1 id="campaign-title" class="card-title">عنوان کمپین</h1>
                <!-- بخش جدید: آدرس مدرسه -->
                <div class="mb-3">
                  <p>
                    <strong>آدرس مدرسه:</strong>
                    <span id="school-address"
                      >تهران، خیابان آزادی، کوچه شهید فلانی، پلاک ۱۲</span
                    >
                  </p>
                </div>

                <p id="campaign-category" class="text-muted">
                  دسته‌بندی: <span id="category-name">در حال بارگذاری...</span>
                </p>

                <p id="campaign-description" class="card-text"></p>
              </div>
            </div>

            <!-- بخش گالری تصاویر -->
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title">گالری تصاویر</h5>
                <div id="campaign-gallery" class="campaign-gallery"></div>
              </div>
            </div>

            <!-- بخش کمک کردن -->
            <div class="donation-section">
              <h5>کمک به این کمپین</h5>
              <form id="donation-form">
                <input
                  type="hidden"
                  id="campaign-id"
                  name="campaign_id"
                  value=""
                />
                <div class="mb-3">
                  <label for="donation-amount" class="form-label"
                    >مبلغ کمک</label
                  >
                  <div class="amount-input-container">
                    <input
                      type="text"
                      class="form-control"
                      id="donation-amount"
                      name="donation_amount"
                      placeholder="مبلغ را وارد کنید"
                      required
                    />
                    <span>تومان</span>
                  </div>
                </div>
                <div class="suggested-amounts">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    data-amount="50000"
                  >
                    ۵۰,۰۰۰ تومان
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    data-amount="100000"
                  >
                    ۱۰۰,۰۰۰ تومان
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    data-amount="200000"
                  >
                    ۲۰۰,۰۰۰ تومان
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    data-amount="500000"
                  >
                    ۵۰۰,۰۰۰ تومان
                  </button>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  کمک کردن
                </button>
              </form>
            </div>
          </div>

          <!-- بخش اطلاعات جانبی و لیست کمک‌کنندگان -->
          <div class="col-md-4">
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title">اطلاعات کمپین</h5>
                <!-- نشان‌دهنده دایره‌ای درصد پیشرفت -->
                <div class="circle-progress">
                  <svg>
                    <circle cx="60" cy="60" r="50"></circle>
                    <circle
                      class="circle-progress-bar"
                      cx="60"
                      cy="60"
                      r="50"
                    ></circle>
                  </svg>
                  <div class="circle-progress-text">60%</div>
                </div>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <strong>تاریخ شروع:</strong>
                    <span id="campaign-start-date">1402/01/01</span>
                  </li>
                  <li class="list-group-item">
                    <strong>هدف مالی:</strong>
                    <span id="campaign-target-amount">10,000,000 تومان</span>
                  </li>
                  <li class="list-group-item">
                    <strong>جمع‌آوری شده:</strong>
                    <span id="campaign-raised-amount">5,000,000 تومان</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- بخش لیست کمک‌کنندگان -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">لیست کمک‌کنندگان</h5>
                <div id="donors-list" class="donors-list">
                  <p class="text-muted">
                    در حال بارگذاری اطلاعات کمک‌کنندگان...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- فوتر -->
    <footer class="footer py-4 mt-5 shadow-sm">
      <div class="container">
        <div class="row text-md-end">
          <!-- ستون اول: درباره ما -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="about.html" class="">
                  درباره ما <i class="bi bi-info-circle"></i>
                </a>
              </li>
              <li>
                <a href="tamasBaMa.html" class="">
                  ارتباط با ما <i class="bi bi-envelope"></i>
                </a>
              </li>
              <li>
                <a href="conditions.html" class="">
                  شرایط و ضوابط <i class="bi bi-file-earmark-text"></i>
                </a>
              </li>
              <li>
                <a href="soalat.html" class="">
                  سوالات متداول <i class="bi bi-question-circle"></i>
                </a>
              </li>
            </ul>
          </div>

          <!-- ستون دوم: لینک‌های مهم -->
          <div class="col-md-4 mb-3">
            <ul class="list-unstyled">
              <li>
                <a href="tamasBaMa.html"> با ما در ارتباط باشید</a>
              </li>
              <li>
                <span>09231055206</span>
              </li>
            </ul>
          </div>
          <!-- ستون سوم: اطلاعات تماس -->
          <div class="col-md-4 mb-3">
            <img src="image/logo.png" alt="" />
          </div>
        </div>
        <hr />
        <div class="social-icons">
          <a href="" data-title="واتساپ">
            <img src="icons/whatsapp.svg" alt="" class="icon icon-w" />
          </a>
          <a href="" data-title="اینستاگرام">
            <img src="icons/instagramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="تلگرام">
            <img src="icons/telegramh.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="آپارات">
            <img src="icons/aparath.svg" alt="" class="icon" />
          </a>
          <a href="" data-title="بله">
            <img src="icons/baleh.svg" alt="" class="icon" />
          </a>
        </div>
      </div>
    </footer>
    <!-- اسکریپت اتصال به بک اند  -->
    <script>
      function displayCampaignDetails(campaign) {
        // نمایش اولین عکس گالری در قسمت عکس اطلاعات کلی
        const campaignImage = document.getElementById("campaign-image");
        if (campaign.gallery && campaign.gallery.length > 0) {
          campaignImage.src = `${BASE_URL}media/${campaign.gallery[0]}`;
        } else {
          campaignImage.src = "image/placeholder.jpg"; // اگر عکسی وجود نداشت، از یک تصویر پیش‌فرض استفاده کنید
        }

        // نمایش عنوان کمپین
        const campaignTitle = document.getElementById("campaign-title");
        campaignTitle.textContent = campaign.title || "بدون عنوان";

        // نمایش توضیحات کمپین
        const campaignDescription = document.getElementById(
          "campaign-description"
        );
        campaignDescription.textContent =
          campaign.description || "بدون توضیحات";

        // نمایش هدف مالی کمپین
        const campaignTargetAmount = document.getElementById(
          "campaign-target-amount"
        );
        campaignTargetAmount.textContent = `${campaign.estimated_money.toLocaleString()} تومان`;

        // نمایش مبلغ جمع‌آوری شده
        const campaignRaisedAmount = document.getElementById(
          "campaign-raised-amount"
        );
        campaignRaisedAmount.textContent = campaign.steel_needed_money
          ? `${campaign.steel_needed_money.toLocaleString()} تومان`
          : "0 تومان";

        // نمایش تاریخ شروع کمپین
        const campaignStartDate = document.getElementById(
          "campaign-start-date"
        );
        const createdDate = new Date(campaign.created_date);
        const formattedDate = createdDate.toLocaleDateString("fa-IR"); // تاریخ به فرمت فارسی
        campaignStartDate.textContent = formattedDate || "بدون تاریخ";

        // نمایش آدرس مدرسه
        const schoolAddress = document.getElementById("school-address");
        schoolAddress.textContent =
          campaign.applicant_info.schoolAddress || "بدون آدرس";

        // نمایش دسته‌بندی کمپین
        const categoryName = document.getElementById("category-name");

        categoryName.textContent = campaign.category || "بدون دسته‌بندی";

        // نمایش درصد پیشرفت
        const progress = campaign.steel_needed_money
          ? Math.round(
              (campaign.steel_needed_money / campaign.estimated_money) * 100
            )
          : 0;
        const circleProgressBar = document.querySelector(
          ".circle-progress-bar"
        );
        const circleProgressText = document.querySelector(
          ".circle-progress-text"
        );
        const circumference = 2 * Math.PI * 50; // محیط دایره (2 * π * r)
        const offset = circumference - (progress / 100) * circumference;
        circleProgressBar.style.strokeDasharray = circumference;
        circleProgressBar.style.strokeDashoffset = offset;
        circleProgressText.textContent = `${progress}%`;

        // نمایش گالری تصاویر
        const campaignGallery = document.getElementById("campaign-gallery");
        if (campaign.gallery && campaign.gallery.length > 0) {
          campaignGallery.innerHTML = campaign.gallery
            .map(
              (image) => `
      <img src="${BASE_URL}media/${image}" class="img-thumbnail" alt="تصویر کمپین" />
    `
            )
            .join("");
        } else {
          campaignGallery.innerHTML = "<p>هیچ تصویری وجود ندارد.</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const accessToken = localStorage.getItem("accessToken");

        // دریافت id کمپین از URL
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get("id");

        if (!campaignId) {
          console.error("Campaign ID not found in URL");
          return;
        }

        // ارسال درخواست به سرور برای دریافت اطلاعات کمپین
        fetch(`${BASE_URL}campaigns/singe_campaign/`, {
          method: "POST", // استفاده از متد POST
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json", // ارسال داده‌ها به صورت JSON
          },
          body: JSON.stringify({ campaign_id: campaignId }), // ارسال id کمپین در بدنه درخواست
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log(data); // بررسی ساختار پاسخ سرور
            displayCampaignDetails(data); // نمایش اطلاعات کمپین
          })
          .catch((error) => {
            console.error("Error fetching campaign details:", error);
          });
      });
    </script>
    <!-- اسکریپت داده محلی  -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // داده‌های محلی برای کمک‌کنندگان
        const mockDonors = [
          { full_name: "علی احمدی", amount: 1000000 },
          { full_name: "مریم محمدی", amount: 500000 },
          { full_name: "ناشناس", amount: 200000 },
          { full_name: "رضا حسینی", amount: 300000 },
          { full_name: "فاطمه کریمی", amount: 150000 },
        ];

        // تابع برای نمایش لیست کمک‌کنندگان
        function populateDonorsList(donors) {
          const donorsListContainer = document.getElementById("donors-list");

          if (donors.length > 0) {
            donorsListContainer.innerHTML = donors
              .map(
                (donor) => `
            <div class="donor-item">
              <span class="donor-name">${donor.full_name || "ناشناس"}</span>
              <span class="donor-amount">${donor.amount.toLocaleString()} تومان</span>
            </div>
          `
              )
              .join("");
          } else {
            donorsListContainer.innerHTML =
              "<p class='text-muted'>هنوز هیچ کمک‌کننده‌ای ثبت نشده است.</p>";
          }
        }

        // نمایش داده‌های محلی
        populateDonorsList(mockDonors);
      });
    </script>
    <!-- اسکریپت کمک کردن  -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const accessToken = localStorage.getItem("accessToken");

        // دریافت id کمپین از URL
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get("id");

        if (!campaignId) {
          console.error("Campaign ID not found in URL");
          return;
        }

        // قرار دادن campaignId در فیلد مخفی
        const campaignIdInput = document.getElementById("campaign-id");
        campaignIdInput.value = campaignId;

        // ارسال درخواست به سرور برای دریافت اطلاعات کمپین
        fetch(`${BASE_URL}campaigns/singe_campaign/`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ campaign_id: campaignId }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log(data);
            displayCampaignDetails(data);
          })
          .catch((error) => {
            console.error("Error fetching campaign details:", error);
          });

        // مدیریت دکمه‌های پیشنهادی
        const suggestedAmountButtons = document.querySelectorAll(
          ".suggested-amounts .btn"
        );
        const donationAmountInput = document.getElementById("donation-amount");

        suggestedAmountButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const amount = this.getAttribute("data-amount");
            donationAmountInput.value = parseInt(amount).toLocaleString();
          });
        });

        // فرمت‌دهی مبلغ وارد‌شده توسط کاربر
        donationAmountInput.addEventListener("input", function () {
          let value = this.value.replace(/,/g, "");
          if (!isNaN(value)) {
            this.value = parseInt(value).toLocaleString();
          }
        });

        // مدیریت فرم کمک کردن
        const donationForm = document.getElementById("donation-form");
        donationForm.addEventListener("submit", function (event) {
          event.preventDefault();

          const amount = donationAmountInput.value.replace(/,/g, "");
          const campaignId = campaignIdInput.value;

          if (amount && amount > 0) {
            // ارسال درخواست به بک‌اند
            fetch(`${BASE_URL}finance/get_bank_url/`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                campaign_id: campaignId,
                amount: amount,
              }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                console.log("Donation successful:", data);

                // ذخیره‌سازی payment_url در localStorage
                localStorage.setItem("payment_url", data.payment_url.url);

                // ذخیره‌سازی مبلغ در localStorage
                localStorage.setItem("amount", amount);

                // هدایت به صفحه پیش‌فاکتور
                window.location.href = "pre-invoice.html";
              })
              .catch((error) => {
                console.error("Error during donation:", error);
                alert("خطا در ارسال کمک. لطفاً دوباره تلاش کنید.");
              });
          } else {
            alert("لطفاً مبلغ معتبری وارد کنید.");
          }
        });
      });

      function displayCampaignDetails(campaign) {
        // نمایش اطلاعات کمپین
        const campaignTitle = document.getElementById("campaign-title");
        campaignTitle.textContent = campaign.title || "بدون عنوان";

        // ذخیره‌سازی نام کمپین در localStorage
        localStorage.setItem("campaign_name", campaign.title);
      }
      document.addEventListener("DOMContentLoaded", function () {
        const donationAmountInput = document.getElementById("donation-amount");

        // اعتبارسنجی ورودی و جلوگیری از نمایش NaN
        donationAmountInput.addEventListener("input", function () {
          let value = this.value.replace(/[^0-9]/g, ""); // حذف کاراکترهای غیرعددی
          if (value === "") {
            value = "0"; // اگر فیلد خالی بود، مقدار پیش‌فرض 0 قرار دهید
          }
          this.value = parseInt(value).toLocaleString(); // نمایش عدد با فرمت مناسب
        });

        // تنظیم مقدار پیش‌فرض هنگام از دست دادن فوکوس
        donationAmountInput.addEventListener("blur", function () {
          if (this.value === "") {
            this.value = "0";
          }
        });

        // دکمه‌های پیشنهادی
        const suggestedAmountButtons = document.querySelectorAll(
          ".suggested-amounts button"
        );
        suggestedAmountButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const amount = this.getAttribute("data-amount");
            donationAmountInput.value = parseInt(amount).toLocaleString();
          });
        });
      });
    </script>

    <script src="app/baseConfig.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app/logintest.js"></script>
  </body>
</html>
